(window.odspNextWebpackJsonp=window.odspNextWebpackJsonp||[]).push([["213"],{"577":function(e,t,n){"use strict";n.r(t);n.d(t,"resourceKey",function(){return M});var r=n(0),i=n(7),s=n(87),o=n(43),u=n(15),a=n(379),f=n(124),l=n(26),c=n(17),h=n(236),p=n(383),d=n(109),v=n(243),m=n(40),g=n(25),y=n(1032),b=n(10),w=n(32),E=n(86),S=n(5),x=n(385),T=n(268),N=n(1379),C=n(2500),k=n(107),L=n(123),A=["ManageVault","Restore","RansomwareDetection"],O=(function(e){Object(r.__extends)(t,e);function t(t,n){void 0===t&&(t={});var r=e.call(this,t,n)||this;r._identityDataSource=n.identityDataSource;r._vroomDataRequestor=n.vroomDataRequestor;r._itemStore=n.itemStore;r._navigation=n.navigation;r._urlDataSource=n.urlDataSource;r._itemProvider=n.itemProvider;r._dialogProvider=n.dialogProvider;r._userInfoProvider=n.userInfoProvider;r._itemParentHelper=n.itemParentHelper;r._bundleLoader=n.bundleLoader;r._storageKeyPrefix=v.t+r._identityDataSource.getIdentity().id;r._dataStore=t.dataStore||new s.e(r._storageKeyPrefix,o.e.local);r._isVaultOpen=r.createObservable(!!r._dataStore.getValue("expirationtime",o.e.local));r._vaultFreState=r.createObservable(v.r.NotCreated);r._vaultSuggestCardState=r.createObservable(0);r._vaultQuota=r.createObservable(void 0);r._quotaLoaded=r.createComputed(r._computeQuotaLoaded);r._isVaultDisabled=r.createObservable(void 0);r._isLocking=!1;r._isOneDriveWinApp=Object(L.e)();r.isOverQuota=r.createPureComputed(r._computeIsOverQuota);r._showVaultLockNotification=r.createObservable(!1);r._showVaultFreMessage=r.createObservable(!1);r.createComputed(r._calculateFreMessage);r.events.on(window,"storage",r._onStorageChange);r.createBackgroundComputed(r._updateVaultQuota);r.isVaultDisabled();r._isVaultOpen.peek()&&(r._getExpiration()<Date.now()?r.lockVault(void 0,!0):r._handleVaultUnlock());return r}t.prototype.vaultLockMessageSubscribe=function(e){this.scope.attach(e.register(this._showVaultLockNotification))};t.prototype.vaultStateSubscribe=function(e){this.scope.attach(e.register(this._isVaultOpen))};t.prototype.vaultFreSubscribe=function(e){this.scope.attach(e.register(this._vaultFreState))};t.prototype.vaultQuotaSubscribe=function(e){this.scope.attach(e.register(this._vaultQuota))};t.prototype.vaultMenuCalloutSubscribe=function(e){this.scope.attach(e.register(this._showVaultFreMessage))};t.prototype.vaultDisabledSubscribe=function(e){this.scope.attach(e.register(this._isVaultDisabled))};t.prototype.getVaultItem=function(){return this._vaultItem};t.prototype.isVaultOpen=function(){return this._isVaultOpen};t.prototype.freState=function(){return this._vaultFreState};t.prototype.suggestCardState=function(){return this._vaultSuggestCardState};t.prototype.getShowVaultFreMessage=function(){return this._showVaultFreMessage()};t.prototype.setShowVaultFreMessage=function(e,t){void 0===t&&(t=!1);t||this._showVaultFreMessage(e);this._setVaultIconFre(e)};t.prototype.unlockVault=function(e,t){var n=this;return this.getVault(!1,!0).then(function(r){if(!r||!r.vault||r.vault.isLocked||e){var i;i=e?n._identityDataSource.getSessionToken(!0):n._isOneDriveWinApp?g.n.resolve({wlidToken:t}):g.n.resolve({accessToken:t});var s={};n._isOneDriveWinApp&&(s.Prefer="Include-Feature=Vault");return i.then(function(t){return n._vroomDataRequestor.send({apiName:"action.unlockVault",path:"/drive/special/vault/action.unlockVault",headers:s,requestType:"POST",postData:JSON.stringify({}),accessToken:t,postProcessQos:n._postProcessUnlockQos.bind(n),useAuthorizationHeaders:!0,qosExtraData:{isExtend:!!e}}).then(function(){n.setVaultLockState({root:void 0,isLocked:!1,expirationInSeconds:1200});if(!e){var t=n._urlDataSource.getRootItemKey();n._itemProvider.invalidateItem(t)}return g.n.resolve({})}).catch(function(e){n._handleVaultLock();return g.n.reject(e)})})}n.setVaultLockState(r.vault,!!t)})};t.prototype.setVaultLockState=function(e,t,n){void 0===t&&(t=!1);if(!this._isLocking){var r=this._isVaultOpen.peek(),i=e.isLocked;if(i||r)i&&r&&this._handleVaultLock(!1,n);else{var s=e.expirationInSeconds||1200,u=Date.now()+1e3*s;this._dataStore.setValue("expirationtime",u,o.e.local);this._handleVaultUnlock(t)}}};t.prototype.lockVault=function(e,t){var n=this;this._isLocking=!0;this._navToRootIfInVault();if(e){var r=this._urlDataSource.getPageType(this._navigation.viewParams),i=this._urlDataSource.getQueryType(this._navigation.viewParams);a.e.logData({name:"Vault.Autolocked",extraData:{location:Object(y.i)(r,i)}})}var s=this._vaultItem?g.n.resolve(this._vaultItem):this.getVault(),o={};this._isOneDriveWinApp&&(o.Prefer="Include-Feature=Vault");return s.then(function(r){return n._vroomDataRequestor.send({apiName:"action.lockVault",path:"/drive/special/vault/action.lockVault",headers:o,requestType:"POST",postData:JSON.stringify({}),postProcessQos:n._postProcessQos.bind(n),qosExtraData:{isAutoLock:!!e}}).then(function(){n._isLocking=!1;n._handleVaultLock(t)}).catch(function(e){n._isLocking=!1;403===e.status?n._handleVaultLock(t):n._showLockFailed();return n._isExpectedError(e)?g.n.resolve():g.n.reject(e)})})};t.prototype.dismissLockNotification=function(){this._showVaultLockNotification(!1)};t.prototype.extendLock=function(){return this.unlockVault(!0)};t.prototype.getVault=function(e,t,n,r){var i=this,s={};e&&(s.Prefer="auto-create-special-folder");this._isOneDriveWinApp&&(s.Prefer=s.Prefer+",Include-Feature=Vault");n=n||"GET";return this._vroomDataRequestor.send({apiName:r?"EnableVault":e?"CreateVault":"GetVault",path:"/drive/special/vault",headers:s,requestType:n,breakCache:!0,qosExtraData:{requestType:n},postProcessQos:this._postProcessQos.bind(this)}).then(function(e){e&&(e.createdBy.user.id=e.createdBy.user.id.toUpperCase());i._vaultItem=e;return e}).catch(function(e){return t?null:g.n.reject(e)})};t.prototype.getQuota=function(){var e=this,t={};this._isOneDriveWinApp&&(t.Prefer="Include-Feature=Vault");return this._vroomDataRequestor.send({apiName:"drive",path:"/drive?select=quota/vault",headers:t,requestType:"GET"}).then(function(t){var n=t&&t.quota&&t.quota.vault;e._vaultQuota(n);return n})};t.prototype.createVaultIfNotExist=function(){var e=this;return this._userInfoProvider.getUserFact(46).then(function(t){if(!t||e._vaultFreState.peek()===v.r.Created)return e.getVault(!0).then(function(t){e.setVaultState(v.r.Created);e._isVaultDisabled(!1);var n=e._urlDataSource.getRootItemKey();e._itemProvider.invalidateItem(n,{triggerFetch:!0});return t});var n=JSON.parse(t.param||"{}");e._vaultFreState(n.s);e._vaultSuggestCardState(n.c)})};t.prototype.isVaultDisabled=function(){var e=this;return void 0!==this._isVaultDisabled.peek()?g.n.wrap(this._isVaultDisabled.peek()):this._userInfoProvider.getUserFact(46).then(function(t){if(t)return e.getVault(!1,!1,"HEAD").then(function(){e._isVaultDisabled(!1);return!1}).catch(function(t){var n=404===t.status;e._isVaultDisabled(n);return n});e._isVaultDisabled(!0);return!0})};t.prototype.enableVault=function(){var e=this;return this.getVault(!0,!1,"GET",!0).then(function(t){var n=e._urlDataSource.getRootItemKey();e._itemProvider.invalidateItem(n,{triggerFetch:!0});e._isVaultDisabled(!1);return t})};t.prototype.disableVault=function(e){var t=this,n={};e&&(n.If="(<"+e+">)");this._isOneDriveWinApp&&(n.Prefer="Include-Feature=Vault");return this._vroomDataRequestor.send({apiName:"deleteVault",headers:n,path:"/drive/special/vault/delete",requestType:"DELETE",postData:JSON.stringify({}),postProcessQos:this._postProcessQos.bind(this)}).then(function(){t._cleanLocalLockInfo();t._isVaultDisabled(!0)}).catch(function(e){var t=e.response;if(t&&t.error&&t.error.fixItUrl){var n=new k.e(t.error.fixItUrl).getQueryParameter("confirmationToken");if(n){0;return n}}return g.n.reject(e)})};t.prototype.setVaultState=function(e,t){var n=void 0;if(void 0!==e&&e>this._vaultFreState.peek()){this._vaultFreState(e);n=e}t&&this._vaultSuggestCardState(t);var r={s:n||this._vaultFreState.peek(),c:t||this._vaultSuggestCardState.peek()};return this._userInfoProvider.setUserInfo(46,3,JSON.stringify(r))};t.prototype.reset=function(){0;return g.n.resolve(!1)};t.prototype.toggleDebug=function(){0};t.prototype._onNavigationChange=function(){var e=this._getCurrentItem(),t=this._navigation.viewParams,n=this._isVaultOpen.peek();if(e){n&&(!e.vault&&A.indexOf(t&&t.v)<=-1?this._detatchIdleEvents():this._attachIdleEvents());if(e.vault&&e.vault.root){if(!this._vaultRootLoadEventFiled){a.e.logData({name:"Vault.Unlocked.Loaded"});this._vaultRootLoadEventFiled=!0}}else this._vaultRootLoadEventFiled=!1}};t.prototype._computeQuotaLoaded=function(){if(this._bundleLoader.getBundleInfo(2).isLoaded()){this._userStateProvider||(this._userStateProvider=this.resources.consume(w.y));return!0}return!1};t.prototype._computeIsOverQuota=function(){var e=this._vaultQuota();return!!e&&e.remainingFiles<=0&&e.totalFiles>0};t.prototype._updateVaultQuota=function(){var e=this._userStateProvider&&this._userStateProvider.quotaNeedsUpdate();this._quotaLoaded()&&e&&this._isVaultOpen()&&this.getQuota()};t.prototype._isDebug=function(){0;return!1};t.prototype._getExpiration=function(){return this._isDebug()?Date.now()+12e4:this._dataStore.getValue("expirationtime",o.e.local)};t.prototype._startExpirationTimers=function(){var e=this;this._expirationWarningTimerId=this.async.setTimeout(function(){e._verifyLockExpiration()},this._getExpiration()-Date.now()-6e4);this._expirationLockTimerId=this.async.setTimeout(function(){0;e.lockVault(!0)},this._getExpiration()-Date.now())};t.prototype._stopExpirationTimers=function(){this.async.clearTimeout(this._expirationWarningTimerId);this.async.clearTimeout(this._expirationLockTimerId)};t.prototype._resetExpirationTimers=function(){0;this._stopExpirationTimers();this._startExpirationTimers()};t.prototype._attachIdleEvents=function(){if(!this._idleEventsAttached){"ontouchstart"in document.documentElement&&this.events.on(document,"touchstart",this._resetLastActivity,!0);this.events.on(document,"mousemove",this._resetLastActivity,!0);this.events.on(document,"keypress",this._resetLastActivity,!0);this._idleEventsAttached=!0;0}};t.prototype._detatchIdleEvents=function(){if(this._idleEventsAttached){"ontouchstart"in document.documentElement&&this.events.off(document,"touchstart",this._resetLastActivity,!0);this.events.off(document,"mousemove",this._resetLastActivity,!0);this.events.off(document,"keypress",this._resetLastActivity,!0);this._idleEventsAttached=!1;0}};t.prototype._resetLastActivity=function(){this._lastActivity=Date.now()};t.prototype._verifyLockExpiration=function(){var e=this;0;if(this._isDebug())this._showLockWarning();else if(Date.now()-this._lastActivity<9e5){0;this.extendLock().then(function(){e._resetExpirationTimers()})}else this.getVault().then(function(t){var n=t.vault&&t.vault.expirationInSeconds||0;if(1e3*n>12e4){0;var r=Date.now()+1e3*n;e._dataStore.setValue("expirationtime",r,o.e.local);e._resetExpirationTimers()}else e._showLockWarning()}).catch(function(t){0;return e.lockVault()})};t.prototype._showLockFailed=function(){var e=this,t=this._dialogProvider.requestDialog({title:C.e.LockFailedDialogTitle,component:{name:N.e.tagName,params:{html:'<span class="ms-fontColor-error">'+C.e.LockFailedDialogBody+"</span>"}},actions:[{name:C.e.LockFailedDialogRetryButton,execute:function(){return g.n.resolve(2)},isAvailable:this.observables.create(!0),icon:new c.e("CheckMark"),isDefault:!0}],isSoftDismissable:!1});t.wait().then(function(){if(2===t.state.peek()){e.async.clearTimeout(e._retryLockVault);e._retryLockVault=e.async.setTimeout(function(){e.lockVault()},500)}})};t.prototype._showLockWarning=function(){var e=this;this._warningDialog=this._dialogProvider.requestDialog({title:C.e.ExpirationDialogTitle,component:{name:T.e.tagName,params:{text:C.e.ExpirationDialogBody}},actions:[{name:C.e.ExpirationDialogExtendButton,execute:function(){a.e.logData({name:"Vault.StillHere.Extend"});return e.extendLock().then(function(){e._resetExpirationTimers();return g.n.resolve(2)})},isAvailable:this.observables.create(!0),icon:new c.e("Cancel"),isDefault:!0}],isSoftDismissable:!1});a.e.logData({name:"Vault.StillHere.Shown"});this._warningDialog.wait().catch(function(){3===e._warningDialog.state.peek()&&a.e.logData({name:"Vault.StillHere.Dismiss"})})};t.prototype._handleVaultLock=function(e,t){this._cleanLocalLockInfo(t);this._showVaultLockNotification(!e)};t.prototype._cleanLocalLockInfo=function(e){var t=this;this._isVaultOpen(!1);this._dataStore.remove("expirationtime",o.e.local);this._stopExpirationTimers();e||this._navToRootIfInVault();this.events.off(this._navigation,"change",this._onNavigationChange);this._navEventAttached=!1;this._getVaultIconFre()||this._showVaultFreMessage(!1);this._detatchIdleEvents();this._warningDialog&&this._warningDialog.dismiss();Object.keys(b.e).map(function(e){var n=t._urlDataSource.getRootItemKey(b.e[e]);t._itemProvider.invalidateItem(n)});var n=this._getCurrentItem();if(this.unwrapObservable(this._itemParentHelper.getFacetedAncestorOrSelf(n,"vault"))){var r=this._urlDataSource.getRootItemKey();this._itemStore.emptyAllOtherSets([r])}else n&&this._itemProvider.invalidateItem(n.key,{emptyAllOtherSets:!0});this._itemStore.invalidateAllVault()};t.prototype._navToRootIfInVault=function(){var e=this._getCurrentItem();if(this.unwrapObservable(this._itemParentHelper.getFacetedAncestorOrSelf(e,"vault"))){var t=this._urlDataSource.getRootItemKey(),n=this._urlDataSource.getItemUrl(t);this._navigation.navigateTo({url:n})}};t.prototype._handleVaultUnlock=function(e){var t=this;void 0===e&&(e=!1);this._isVaultOpen(!0);this._resetExpirationTimers();var n=this._urlDataSource.getRootItemKey();this._itemProvider.invalidateItem(n,{triggerFetch:!0});if(!this._navEventAttached){this.events.on(this._navigation,"change",this._onNavigationChange);this._navEventAttached=!0;this._onNavigationChange()}this.getQuota();this._warningDialog&&this._warningDialog.dismiss();var r=this._getCurrentItem();if(r&&(r.vault||r.isPlaceholder||r.error&&r.error.data&&161===r.error.data.errorCode||r.queryType===b.e.RecycleBin&&"root"===r.id)){this._itemProvider.invalidateItem(r.key,{triggerFetch:!0});var i=this._urlDataSource.getFocusItemKey(this._navigation.viewParams);i&&this._itemProvider.invalidateItem(i,{purgeCache:!0})}this._showVaultLockNotification(!1);a.e.logData({name:"Vault.Unlocked.Succeeded"});if(this._getVaultIconFre()&&!e){this.async.setTimeout(function(){t._showVaultFreMessage(!0)},5e3);this._setVaultIconFre(!1)}};t.prototype._onStorageChange=function(e){var t=e.key,n=e.oldValue,r=e.newValue;if(t===this._storageKeyPrefix+v.e&&r)try{var i=JSON.parse(r);FilesConfig.canary!==i&&(FilesConfig.canary=FilesConfig.navCanary=i)}catch(e){}if(t===this._storageKeyPrefix+"expirationtime")if(r){if(!n||r>n){this._dataStore.getValue("expirationtime",o.e.local)||this._dataStore.setValue("expirationtime",parseInt(r,10),o.e.local);this._handleVaultUnlock()}}else this._isVaultOpen.peek()&&this._handleVaultLock()};t.prototype._calculateFreMessage=function(){var e=this;this._getVaultIconFre()&&this.async.setTimeout(function(){e._showVaultFreMessage(!0)},5e3)};t.prototype._getCurrentItem=function(){var e=this._urlDataSource.getCurrentItemKey(this._navigation.viewParams);return this.unwrapObservable(this._itemStore.getItem(e))};t.prototype._getVaultIconFre=function(){return this._dataStore.getValue("vaultMenuCalloutMessageShow",o.e.local)};t.prototype._setVaultIconFre=function(e){e?this._dataStore.setValue("vaultMenuCalloutMessageShow",e,o.e.local):this._dataStore.remove("vaultMenuCalloutMessageShow",o.e.local)};t.prototype._postProcessQos=function(e,t){this._isExpectedError(t)&&(e.resultType=l.e.ExpectedFailure);return e};t.prototype._postProcessUnlockQos=function(e,t){this._isExpectedUnlockError(t)&&(e.resultType=l.e.ExpectedFailure);return e};t.prototype._isExpectedError=function(e){if(400===e.status||403===e.status){var t=Object(h.i)(e);if("memberdoesnotexist"===(t=t&&t.toLowerCase())||"unlockrequired"===t||"accessdenied"===t||"confirmationrequired"===t)return!0}else if(404===e.status)return!0;return!1};t.prototype._isExpectedUnlockError=function(e){var t=Object(h.i)(e);if("vaultunlockextensiontimeexceeded"===(t=t&&t.toLowerCase())){a.e.logData({name:"Vault.Unlock.MaxExtensionError"});return!0}return!1};return t})(i.n);t.default=O;var M=Object(S.s)("VaultDataSource",O,Object(r.__assign)(Object(r.__assign)({},i.n.dependencies),{identityDataSource:u.x,vroomDataRequestor:x.e,itemStore:d.e,urlDataSource:u.be,navigation:m.e,itemProvider:E.resourceKey,dialogProvider:f.e,userInfoProvider:w.L,itemParentHelper:p.e,bundleLoader:w.e}))},"1032":function(e,t,n){"use strict";n.d(t,"e",function(){return o});n.d(t,"n",function(){return u});n.d(t,"t",function(){return a});n.d(t,"r",function(){return f});n.d(t,"s",function(){return l});n.d(t,"i",function(){return c});var r=n(12),i=n(10),s=["","Lock","Unlock","Manage","FreDialog","Unlock","Reset","Debug","FilesRemaining"],o="PVault-IconUpsell",u="PVault-QuotaBannerLearnMore",a="PVault-QuotaBannerGoPremium",f="PVault-QuotaErrorLearnMore";function l(e){return s[e]}function c(e,t){var n;switch(e){case r.e.Files:n="Files";break;case r.e.Restore:n="Restore";break;case r.e.RansomwareDetection:n="RansomwareDetection";break;case r.e.ManageVault:n="ManageVault";break;default:n=""}return t?n+"-"+i.e[t]:""+n}},"1379":function(e,t,n){"use strict";var r=n(0),i=(function(e){Object(r.__extends)(t,e);function t(t){var n=e.call(this,t)||this;n.html=t.html;return n}return t})(n(9).t),s=n(16).e({tagName:"ms-html-container",template:'<div class="HTMLContainer" data-bind="html:html"></div>',viewModel:i});t.e=s}}]);